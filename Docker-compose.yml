services:
  db:
    image: postgres:14
    container_name: db
    restart: unless-stopped
    environment:
      POSTGRES_DB: bema_crm_table_schema
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: Admin
    ports:
      - "6543:5432"
    volumes:
      - db-data:/var/lib/postgresql/data
      # Apply schema automatically on first init
      - ./sql/schema.sql:/docker-entrypoint-initdb.d/schema.sql:ro

  app:
    build: .
    container_name: bema_crm_app
    restart: always
    depends_on:
      - db
    env_file:
      - .env
    ports:
      - "4000:3000"
    # Small delay so DB is ready before Node starts
    command: sh -c "sleep 10 && npm start"
    # For local dev hot reload, you can uncomment this:
    # volumes:
    #   - .:/usr/src/app

  n8n:
    image: n8nio/n8n:latest
    container_name: n8n-bema_backend
    restart: unless-stopped
    depends_on:
      - db
      - app
    ports:
      - "5678:5678"
    environment:
      # Basic auth for the n8n UI
      N8N_BASIC_AUTH_ACTIVE: "true"
      N8N_BASIC_AUTH_USER: admin
      N8N_BASIC_AUTH_PASSWORD: admin123

      # How n8n thinks about its own URL (external access)
      N8N_HOST: "localhost"
      N8N_PORT: 5678
      N8N_PROTOCOL: "http"

      # Timezone
      GENERIC_TIMEZONE: "Africa/Lagos"

      # Optional: if you expose n8n externally, set WEBHOOK_URL to the public URL
      # WEBHOOK_URL: "https://your-domain.com/"
    volumes:
      - n8n_data:/home/node/.n8n
    user: "1000:1000"

volumes:
  db-data:
  n8n_data:
